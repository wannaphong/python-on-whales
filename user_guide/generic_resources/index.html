<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Swarm generic resources - Python on whales</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Python on whales</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../../docker_client/" class="nav-link">Docker client</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Sub-commands <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../sub-commands/buildx/" class="dropdown-item">docker buildx</a>
</li>
                                    
<li>
    <a href="../../sub-commands/compose/" class="dropdown-item">docker compose</a>
</li>
                                    
<li>
    <a href="../../sub-commands/config/" class="dropdown-item">docker config</a>
</li>
                                    
<li>
    <a href="../../sub-commands/container/" class="dropdown-item">docker container</a>
</li>
                                    
<li>
    <a href="../../sub-commands/context/" class="dropdown-item">docker context</a>
</li>
                                    
<li>
    <a href="../../sub-commands/image/" class="dropdown-item">docker image</a>
</li>
                                    
<li>
    <a href="../../sub-commands/manifest/" class="dropdown-item">docker manifest</a>
</li>
                                    
<li>
    <a href="../../sub-commands/network/" class="dropdown-item">docker network</a>
</li>
                                    
<li>
    <a href="../../sub-commands/node/" class="dropdown-item">docker node</a>
</li>
                                    
<li>
    <a href="../../sub-commands/plugin/" class="dropdown-item">docker plugin</a>
</li>
                                    
<li>
    <a href="../../sub-commands/secret/" class="dropdown-item">docker secret</a>
</li>
                                    
<li>
    <a href="../../sub-commands/service/" class="dropdown-item">docker service</a>
</li>
                                    
<li>
    <a href="../../sub-commands/stack/" class="dropdown-item">docker stack</a>
</li>
                                    
<li>
    <a href="../../sub-commands/swarm/" class="dropdown-item">docker swarm</a>
</li>
                                    
<li>
    <a href="../../sub-commands/system/" class="dropdown-item">docker system</a>
</li>
                                    
<li>
    <a href="../../sub-commands/task/" class="dropdown-item">docker task</a>
</li>
                                    
<li>
    <a href="../../sub-commands/trust/" class="dropdown-item">docker trust</a>
</li>
                                    
<li>
    <a href="../../sub-commands/volume/" class="dropdown-item">docker volume</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Docker objects <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../docker_objects/builders/" class="dropdown-item">Builders</a>
</li>
                                    
<li>
    <a href="../../docker_objects/configs/" class="dropdown-item">Configs</a>
</li>
                                    
<li>
    <a href="../../docker_objects/containers/" class="dropdown-item">Containers</a>
</li>
                                    
<li>
    <a href="../../docker_objects/images/" class="dropdown-item">Images</a>
</li>
                                    
<li>
    <a href="../../docker_objects/networks/" class="dropdown-item">Networks</a>
</li>
                                    
<li>
    <a href="../../docker_objects/nodes/" class="dropdown-item">Nodes</a>
</li>
                                    
<li>
    <a href="../../docker_objects/plugins/" class="dropdown-item">Plugins</a>
</li>
                                    
<li>
    <a href="../../docker_objects/secrets/" class="dropdown-item">Secrets</a>
</li>
                                    
<li>
    <a href="../../docker_objects/services/" class="dropdown-item">Services</a>
</li>
                                    
<li>
    <a href="../../docker_objects/stacks/" class="dropdown-item">Stacks</a>
</li>
                                    
<li>
    <a href="../../docker_objects/tasks/" class="dropdown-item">Tasks</a>
</li>
                                    
<li>
    <a href="../../docker_objects/volumes/" class="dropdown-item">Volumes</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">User guide <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../docker_run/" class="dropdown-item">docker.run() guide</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Swarm generic resources</a>
</li>
                                    
<li>
    <a href="../running_python_on_whales_inside_a_container/" class="dropdown-item">Running python-on-whales inside a container</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../docker_run/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../running_python_on_whales_inside_a_container/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#docker-swarm-generic-resources" class="nav-link">Docker Swarm generic resources</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#named-resources" class="nav-link">Named resources</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#discreet-resources" class="nav-link">Discreet resources</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="docker-swarm-generic-resources">Docker Swarm generic resources</h1>
<p>There are two kind of generic resources, discreet and named.</p>
<p>Both are declared in <code>/etc/docker/daemon.json</code> and both are 
accessible in your containers as environment variables.</p>
<h2 id="named-resources">Named resources</h2>
<p>Named resources should be used when you have a small number of things you want accessed.
The best example is gpu devices. Each gpu has a UUID, which can be the 
name of this resources. Actually you could also use an index, and this index would have 
to be the "name" of the gpu.</p>
<p>Since we want to show they're generic, let's take something else than GPUs for this example.</p>
<p>Let's say you have 5 hamsters connected to your node, making an app run:</p>
<p><img src="https://i.imgur.com/6bjNsYU.gif" alt="logo" class="responsive" style="width: 45%; height: auto;">
<img src="https://i.imgur.com/6bjNsYU.gif" alt="logo" class="responsive" style="width: 45%; height: auto;">
<img src="https://i.imgur.com/6bjNsYU.gif" alt="logo" class="responsive" style="width: 30%; height: auto;">
<img src="https://i.imgur.com/6bjNsYU.gif" alt="logo" class="responsive" style="width: 30%; height: auto;">
<img src="https://i.imgur.com/6bjNsYU.gif" alt="logo" class="responsive" style="width: 30%; height: auto;"></p>
<p>They are named Robert, Lucie, Annie, James and Stacy.</p>
<p>You'll define one service that needs one hamster and one that needs three.
We'll call them <code>my_light_service</code> and <code>my_heavy_service</code>.</p>
<p>Let's declare the hamsters in the <code>/etc/docker/daemon.json</code>. If this file doesn't exist
on your system, you can create it.</p>
<p>Mine looks like this, note that you don't need the insecure registries part:</p>
<pre><code class="json">{
    &quot;insecure-registries&quot;: [&quot;127.0.0.1:5000&quot;],
    &quot;node-generic-resources&quot;: [
        &quot;hamster=Robert&quot;,
        &quot;hamster=Lucie&quot;,
        &quot;hamster=Annie&quot;,
        &quot;hamster=James&quot;,
        &quot;hamster=Stacy&quot;
    ]
}
</code></pre>

<p>Restart your Docker daemon with <code>sudo service docker restart</code>.</p>
<p>Then create a Docker swarm: <code>docker swarm init</code></p>
<p>The hamster are declared, up and ready to go! 
You can check they're here with <code>docker node ls</code> and <code>docker node inspect</code>.</p>
<h3 id="creating-services-with-the-cli">Creating services with the CLI</h3>
<p>It's time to create services and hit those hamsters!</p>
<p>First we'll create the services with the CLI and then with the command line.</p>
<pre><code>$ docker service create --generic-resource &quot;hamster=1&quot; --name my_light_service ubuntu bash -c &quot;env &amp;&amp; sleep infinity&quot;
$ docker service create --generic-resource &quot;hamster=3&quot; --name my_heavy_service ubuntu bash -c &quot;env &amp;&amp; sleep infinity&quot;
</code></pre>

<p>We have one replica for the light and heavy service. They use 4 hamster. Let's try to use moooooooore!</p>
<pre><code class="bash">$ docker service scale -d my_light_service=10 my_heavy_service=10
$ docker service ls
ID                  NAME                MODE                REPLICAS            IMAGE               PORTS
tt436bxjtdn7        my_heavy_service    replicated          1/10                 ubuntu:latest
ksiq5x0bxch1        my_light_service    replicated          2/10                 ubuntu:latest
</code></pre>

<p>Remember, we only have 5 hamsters, and 3 are needed for the heavy service and one for the light service.
Hence here 2 * 1 + 1 * 3 = 5 ! This is what we wanted. So how does each container knows which hamster to use?</p>
<p>We asked each container to print the environment variables and sleep for infinity <code>env &amp;&amp; sleep infinity</code>.
Let's take a look with <code>docker logs</code>:</p>
<pre><code class="bash">$ docker ps
CONTAINER ID IMAGE          COMMAND                NAMES
1e8932f5a985 ubuntu:latest  &quot;bash -c 'env &amp;&amp; sle…&quot; my_light_service.4.shys2wwxz7jjfjg2g2e0xl1sw
0a5c4ddd303a ubuntu:latest  &quot;bash -c 'env &amp;&amp; sle…&quot; my_heavy_service.1.p39satddgf6j1uhspdiohcyzh
e2872006cc97 ubuntu:latest  &quot;bash -c 'env &amp;&amp; sle…&quot; my_light_service.1.bbo0fbi5d5e2zdwozgbse8x57

$ docker logs my_light_service.4.shys2wwxz7jjfjg2g2e0xl1sw
DOCKER_RESOURCE_HAMSTER=Stacy
HOSTNAME=1e8932f5a985

$ docker logs my_heavy_service.1.p39satddgf6j1uhspdiohcyzh
DOCKER_RESOURCE_HAMSTER=Lucie,Annie,James
HOSTNAME=0a5c4ddd303a

$ docker logs my_light_service.1.bbo0fbi5d5e2zdwozgbse8x57
DOCKER_RESOURCE_HAMSTER=Robert
HOSTNAME=e2872006cc97
</code></pre>

<p>So we can see that each container is aware of it's hamster with an environment variable.
The process running in the container can grab it and then use the correct hamster without 
making two containers use the same hamster.</p>
<h3 id="using-hamsters-with-docker-stack">Using hamsters with Docker stack</h3>
<p>Here is a <code>docker-compose.yml</code> that will declare the services exactly like we did in the CLI:</p>
<pre><code class="yaml">version: &quot;3.8&quot;

services:
  my_light_service:
    command:
      - bash
      - -c
      - env &amp;&amp; sleep infinity
    image: ubuntu
    deploy:
      replicas: 10
      resources:
        reservations:
          generic_resources:
            - discrete_resource_spec:
                kind: 'hamster'
                value: 1

  my_heavy_service:
    command:
      - bash
      - -c
      - env &amp;&amp; sleep infinity
    image: ubuntu
    deploy:
      replicas: 10
      resources:
        reservations:
          generic_resources:
            - discrete_resource_spec:
                kind: 'hamster'
                value: 3
</code></pre>

<pre><code class="bash">$ docker stack deploy -c docker-compose.yml my_stack_using_hamsters
Creating network my_stack_using_hamsters_default
Creating service my_stack_using_hamsters_my_heavy_service
Creating service my_stack_using_hamsters_my_light_service

$ docker service ls
ID              NAME                                       MODE        REPLICAS  IMAGE 
nlhwfnz0d1cx    my_stack_using_hamsters_my_heavy_service   replicated  1/10      ubuntu:latest
c77tv3czzfw2    my_stack_using_hamsters_my_light_service   replicated  2/10      ubuntu:latest
</code></pre>

<h3 id="how-does-that-fit-with-nvidia-gpus">How does that fit with Nvidia GPUs?</h3>
<p>Well, if you remember, the Nvidia runtime uses environment variables in the container to know which gpu to use.</p>
<p>By modifying the <code>/etc/nvidia-container-runtime/config.toml</code>, 
and setting <code>swarm-resource = "DOCKER_RESOURCE_GPU"</code>, it indicates the nvidia-docker runtime 
that it should watch for this environment variable when deciding which gpu to use.
Make the nvidia-docker runtime the default one for this node, replace hamster by gpu and you're good to
go as long as you used UUID as your hamster's names.</p>
<p>A more in depth guide can be found <a href="https://gist.github.com/tomlankhorst/33da3c4b9edbde5c83fc1244f010815c">here</a>.</p>
<h2 id="discreet-resources">Discreet resources</h2>
<p>TODO (just put <code>"node-generic-resources": ["hamster=100"]</code> in the daemon.json, there are too many hamsters to give them names).</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
